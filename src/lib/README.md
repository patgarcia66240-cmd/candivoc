# üîç Services de Monitoring - CandiVoc

Cette documentation explique l'architecture de monitoring unifi√©e mise en place pour CandiVoc.

---

## üèóÔ∏è Architecture de Monitoring

### üì¶ Services Principaux

1. **MonitoringService** (`src/lib/monitoring.ts`) - Service unifi√©
2. **Sentry** (`src/lib/sentry.ts`) - Error tracking & performance
3. **Analytics** (`src/lib/analytics.ts`) - User behavior tracking
4. **Performance** (`src/lib/performance.ts`) - Core Web Vitals

### üîÑ Flux de Donn√©es

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   App.tsx      ‚îÇ  ‚Üê Point d'entr√©e unique
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Services   ‚îÇ  ‚Üê Initialisation automatique
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Monitoring ‚îÇ  ‚Üê Agr√©gation & unified
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Platforms  ‚îÇ  ‚Üê Sentry, Analytics, Browser APIs
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üî• Sentry - Error Tracking

### üéØ Fonctionnalit√©s

```typescript
// Initialisation automatique
MonitoringService.init()

// Capture d'erreurs manuelles
MonitoringService.captureException(error, context)

// Tags et contexte
MonitoringService.setTags({ user_type: 'premium' })
MonitoringService.setContext('feature', 'chat_interface')
```

### üìä Types de Donn√©es Collect√©es

- **Erreurs JavaScript** automatiques et manuelles
- **Performance traces** avec timing des op√©rations
- **User sessions** avec identifiants et contexte
- **Network requests** avec statuts et dur√©es
- **Breadcrumbs** de navigation utilisateur

### üîß Configuration

```typescript
Sentry.init({
  dsn: import.meta.env.VITE_SENTRY_DSN,
  environment: import.meta.env.MODE,
  tracesSampleRate: import.meta.env.PROD ? 0.1 : 1.0,
  maxBreadcrumbs: 50,
  autoSessionTracking: true,
})
```

---

## üìä Analytics - User Behavior

### üéØ √âv√©nements Tracking

```typescript
// √âv√©nements personnalis√©s
AnalyticsService.trackEvent('feature_used', {
  category: 'Engagement',
  feature: 'voice_recording',
  context: 'scenarios_page'
})

// Pages vues
AnalyticsService.pageView('/dashboard', 'Tableau de bord')

// √âv√©nements m√©tier
AnalyticsService.trackScenarioStart('scenario_123', 'technical')
AnalyticsService.trackSessionEnd('scenario_123', 120, 15)
```

### üì° Google Analytics 4

- **Configuration automatique** avec `VITE_GA_ID`
- **GDPR compliant** avec consentement
- **Fallback local** pour d√©veloppement
- **Events personnalis√©s** pour CandiVoc

### üîë Types d'√âv√©nements

| Cat√©gorie | √âv√©nement | Description |
|----------|----------|------------|
| `Engagement` | `scenario_started` | Lancement d'un sc√©nario |
| `Engagement` | `scenario_completed` | Fin d'un sc√©nario |
| `Session` | `session_started` | D√©but d'entra√Ænement |
| `Monetization` | `subscription_success` | Abonnement r√©ussi |
| `Feature` | `feature_used` | Utilisation d'une fonctionnalit√© |

---

## ‚ö° Performance - Core Web Vitals

### üéØ M√©triques Collect√©es

```typescript
// Scores de performance
const score = PerformanceService.getPerformanceScore()
// { overall: 'good', lcp: 'good', fid: 'needs-improvement', cls: 'good' }

// Mesures personnalis√©es
PerformanceService.measureOperation('scenario_load', async () => {
  await loadScenario()
})
```

### üìà Seuils Google Web Vitals

| M√©trique | Bon | Moyen | Mauvais |
|-----------|------|--------|----------|
| **LCP** | ‚â§ 2.5s | ‚â§ 4s | > 4s |
| **FID** | ‚â§ 100ms | ‚â§ 300ms | > 300ms |
| **CLS** | ‚â§ 0.1 | ‚â§ 0.25 | > 0.25 |

### üîç Monitoring des Ressources

- **Scripts** : nombre, taille, dur√©e
- **CSS** : optimisation et chargement
- **Images** : poids et formats
- **API calls** : latence et erreurs

---

## üîß Configuration et D√©ploiement

### üåç Variables d'Environnement

```bash
# .env.local
VITE_SENTRY_DSN=https://your-dsn@sentry.io/project-id
VITE_GA_ID=G-XXXXXXXXXX
VITE_APP_VERSION=1.4.0
VITE_BUILD_DATE=2024-12-27
```

### üö´ Modes de D√©sactivation

Les services sont automatiquement d√©sactiv√©s en d√©veloppement :

```typescript
if (import.meta.env.DEV || import.meta.env.MODE === 'development') {
  console.log('üö´ Monitoring d√©sactiv√© en d√©veloppement')
  return
}
```

### üî• Integration dans l'Application

```typescript
// App.tsx
const App = () => {
  React.useEffect(() => {
    MonitoringService.init()
    AnalyticsService.init()
    PerformanceService.init()
  }, [])

  return (
    <MonitoringService.ErrorBoundary fallback={ErrorFallback}>
      <Router>
        <AppRoutes />
      </Router>
    </MonitoringService.ErrorBoundary>
  )
}
```

---

## üì± Utilisation dans les Composants

### üéØ Hook de Performance

```typescript
const MyComponent = () => {
  const measureRender = PerformanceService.measureComponentRender('MyComponent')

  return (
    <div>
      {/* contenu */}
    </div>
  )
}
```

### üîç Tracking Utilisateur

```typescript
const useAuthTracking = () => {
  useEffect(() => {
    if (user) {
      MonitoringService.setUser(user)
      AnalyticsService.setUserId(user.id)
    }
  }, [user])
}
```

### üìä M√©triques M√©tier

```typescript
const handleScenarioComplete = (scenarioId: string, duration: number) => {
  AnalyticsService.trackScenarioComplete(scenarioId, duration)
  PerformanceService.captureMetric('scenario_duration', duration, 'seconds')
  MonitoringService.setTags({ last_scenario: scenarioId })
}
```

---

## üìä Tableaux de Bord Monitoring

### üö® Tableau de Bord Sentry

- **Erreurs en temps r√©el** : cat√©goris√©es par s√©v√©rit√©
- **Performance traces** : identification des goulots d'√©tranglement
- **User feedback** : √©valuations automatiques et manuelles
- **Trends** : √©volution des erreurs dans le temps

### üìà Tableau de Bord Analytics

- **Funnels de conversion** : landing ‚Üí inscription ‚Üí abonnement
- **Utilisation par fonctionnalit√©** : fr√©quence d'utilisation par feature
- **Sessions actives** : temps moyen, nombre de sc√©narios
- **User segments** : comportements par type d'utilisateur

### ‚ö° Tableau de Bord Performance

- **Core Web Vitals** : LCP, FID, CLS par version et device
- **Resource performance** : poids et temps de chargement des assets
- **API performance** : latence des endpoints critiques
- **Bundle analysis** : size et impact sur le temps de chargement

---

## üîç Debug et Development

### üì° Export Local Analytics

```typescript
// En d√©veloppement uniquement
if (import.meta.env.DEV) {
  AnalyticsService.exportLocalData()
  // G√©n√®re un CSV avec les √©v√©nements locaux
}
```

### üîß Logs Structur√©s

```typescript
// Erreurs
üö® Sentry Error: NetworkError + context

// Analytics
üìä Analytics Event: scenario_started + properties

// Performance
üìä Performance Metric: component_render_Dashboard = 45ms
```

### üìâ Visualisation des Donn√©es

```typescript
// Ajouter au endpoint de monitoring
app.get('/debug/analytics', (req, res) => {
  const data = localStorage.getItem('candivoc_analytics')
  res.json({ events: JSON.parse(data), timestamp: Date.now() })
})
```

---

## üõ°Ô∏è S√©curit√© et Confidentialit√©

### üîê Donn√©es Collect√©es

- **Sentry** : stack traces, contexte applicatif, m√©tadonn√©es
- **Analytics** : interactions utilisateur, performance, events m√©tier
- **Performance** : m√©triques techniques, timing des ressources
- **Aucune donn√©e personnelle sensible** : mots de passe, conversations priv√©es

### üîí Anonymisation

```typescript
// Masquage automatique des IPs
beforeSend(event) {
  // Supprimer les 3 derniers octets de l'IP
  const anonymizedIp = request.ip.replace(/\d+$/, 'xxx')
  event.user.ip = anonymizedIp
}
```

### üîë Consentement GDPR

```typescript
// Banni√®re de consentement int√©gr√©e
AnalyticsService.setConsent(consentGiven)

// D√©sactivation imm√©diate si refus
if (!consent) {
  window.gtag('config', 'GA_ID', {
    privacy_features: { 'analytics_storage': 'denied' }
  })
}
```

---

## üîß Alertes et Notifications

### üö® Alertes Configur√©es

- **Erreurs critiques** : notification imm√©diate
- **Taux d'erreur > 5%** : alerte automatique
- **Performance d√©grad√©e** : score < 'needs-improvement'
- **Drop significatif** : r√©duction de trafic > 20%

### üìß Notifications par Email

```typescript
// Configuration Sentry (dashboard Sentry.io)
- Erreurs critiques : imm√©diat
- Rapports quotidiens : r√©sum√© des erreurs
- Alertes de performance : seuils d√©pass√©s
```

---

## üìà M√©triques de Succ√®s

### Objectifs Monitoring

| KPI | Cible | Actuel | Tendance |
|-----|--------|---------|----------|
| **Error Rate** | < 1% | ? | ‚¨áÔ∏è |
| **Performance Score** | > 90% | ? | ‚¨ÜÔ∏è |
| **User Engagement** | > 75% | ? | ‚û°Ô∏è |
| **Page Load Time** | < 3s | ? | ‚¨áÔ∏è |

### üìä Reports Automatis√©s

- **Hebdomadaires** : synth√®se performance et erreurs
- **Mensuels** : KPIs et tendances
- **Trimestriels** : √©volutions majeures et objectifs
- **Incidents** : rapports post-incident

---

## üöÄ Bonnes Pratiques

### üìù Int√©gration dans les Composants

```typescript
// Wrapper de composant avec monitoring
export const WithMonitoring = <P,>({ children }) => {
  const transaction = MonitoringService.useTransaction('ComponentRender', 'ui')

  React.useEffect(() => {
    transaction.start()
    return () => transaction.finish()
  })

  return <Component />
}
```

### üîç Tests de Monitoring

```typescript
// Tests unitaires des services
describe('AnalyticsService', () => {
  it('devrait envoyer les √©v√©nements', () => {
    const mockGtag = vi.fn()
    window.gtag = mockGtag

    AnalyticsService.trackEvent('test')
    expect(mockGtag).toHaveBeenCalledWith('event', 'test', {})
  })
})
```

### üîÑ Migration et R√©trocompatibilit√©

```typescript
// Support des anciennes versions
const legacyTrackEvent = (name: string, props: any) => {
  // Convertir vers nouveau format
  AnalyticsService.trackEvent(name, {
    category: 'legacy',
    ...props
  })
}
```

---

## üî® Maintenance et √âvolution

### üìÖ Revues Quotidiennes

- **Dashboard Sentry** : erreurs et performance
- **Google Analytics** : tendances utilisateur
- **Performance monitoring** : Core Web Vitals
- **Error trends** : √©volution des erreurs

### üîÑ Am√©liorations Continues

- **Nouveaux types d'√©v√©nements** : fonctionnalit√©s m√©tier
- **M√©triques personnalis√©es** : indicateurs de succ√®s
- **Alertes pr√©dictives** : identification proactive des probl√®mes
- **Tableaux de bord** : visualisations interactives

---

## üîó Ressources et Documentation

### üìö Liens Utiles

- **Sentry Documentation** : https://docs.sentry.io/
- **Google Analytics 4** : https://developers.google.com/analytics/
- **Web Vitals Guide** : https://web.dev/vitals/
- **Performance API** : https://developer.mozilla.org/en-US/docs/Web/API/Performance

### üõ†Ô∏è Outils D√©veloppement

- **Sentry CLI** : `npm install @sentry/cli`
- **Analytics Debug** : Chrome Extension Google Analytics Debugger
- **Performance Audit** : Lighthouse de Chrome DevTools
- **Network Throttling** : DevTools pour simulation connexion lente

---

*Pour toute question sur l'impl√©mentation ou l'optimisation du monitoring, n'h√©sitez pas √† contacter l'√©quipe technique.*