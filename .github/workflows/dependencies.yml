name: ğŸ”’ Dependencies & Security

on:
  schedule:
    # Tous les lundis Ã  9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['package*.json']

jobs:
  # ğŸ“¦ Mise Ã  jour des dÃ©pendances
  update:
    name: ğŸ“¦ Update Dependencies
    runs-on: ubuntu-latest

    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      commit-sha: ${{ steps.commit.outputs.sha }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ” Check for updates
        id: check
        run: |
          OUTDATED=$(npm outdated --json || echo '{}')
          if [ "$OUTDATED" != "{}" ]; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Updates available:"
            echo "$OUTDATED" | jq -r 'to_entries[] | "  \(.key): \(.value.current) â†’ \(.value.latest)"'
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All dependencies are up to date"
          fi
        continue-on-error: true

      - name: ğŸ”„ Update dependencies
        if: steps.check.outputs.has-updates == 'true'
        run: |
          npm update
          npm audit fix --audit-level moderate || true

      - name: ğŸ§ª Test updates
        if: steps.check.outputs.has-updates == 'true'
        run: |
          npm run lint
          npm run test
          npm run build
        continue-on-error: true

      - name: ğŸ“ Commit updates
        id: commit
        if: steps.check.outputs.has-updates == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package*.json npm-shrinkwrap.json
          git commit -m "ğŸ“¦ chore: update dependencies [skip ci]"
          git push
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create PR if needed
        if: steps.check.outputs.has-updates == 'true' && failure()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ“¦ chore: update dependencies"
          title: "ğŸ“¦ Automated dependency updates"
          body: |
            ## ğŸ“¦ Dependency Updates

            This PR contains automated dependency updates.

            ### âœ… Checks performed
            - [x] Dependencies updated
            - [x] Security audit
            - [x] Build successful
            - [x] Tests passing

            ### ğŸ“‹ Review checklist
            - [ ] Review breaking changes
            - [ ] Test critical functionality
            - [ ] Verify no regressions

            > ğŸ¤– This PR was created automatically by GitHub Actions

  # ğŸ” Audit de sÃ©curitÃ©
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ”’ Run security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level moderate

      - name: ğŸ” Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: ğŸ“Š Upload Snyk results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk.sarif

      - name: ğŸ“¨ Security alert
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: 'danger'
          channel: '#security'
          text: |
            ğŸ”’ Security vulnerabilities detected!
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ”— Commit: ${{ github.sha }}
            ğŸ› ï¸ Action required: Review and fix vulnerabilities
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_SECURITY }}

  # ğŸ“Š License compliance
  license-check:
    name: ğŸ“œ License Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ“œ Check licenses
        run: |
          npm install -g license-checker
          license-checker --summary --excludePrivatePackages

      - name: ğŸ“Š Generate license report
        run: |
          license-checker --json > license-report.json
          echo "ğŸ“„ License report generated"

      - name: ğŸ“¤ Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 90